import React, { useState, useEffect, useRef } from 'react';
import { 
  Sparkles, TrendingUp, X, Menu, Sun, Moon, 
  ExternalLink, Cpu, Lock, FileText, Download, 
  ArrowUpRight, ShieldAlert, User, MousePointer2 
} from 'lucide-react';

const App = () => {
  const [isLoading, setIsLoading] = useState(true);
  const [isDark, setIsDark] = useState(true);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isCVModalOpen, setIsCVModalOpen] = useState(false);
  const [cvPassword, setCvPassword] = useState("");
  const [isCvUnlocked, setIsCvUnlocked] = useState(false);
  const [passwordError, setPasswordError] = useState(false);
  const [scrollProgress, setScrollProgress] = useState(0);
  const [cursorPos, setCursorPos] = useState({ x: -100, y: -100 });
  const [visitorCount, setVisitorCount] = useState(0);

  // 粒子特效邏輯
  const canvasRef = useRef(null);
  
  useEffect(() => {
    if (isDark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [isDark]);

  useEffect(() => {
    // 滾動與鼠標邏輯
    const handleScroll = () => setScrollProgress(window.scrollY / (document.documentElement.scrollHeight - window.innerHeight));
    const moveCursor = (e) => setCursorPos({ x: e.clientX, y: e.clientY });
    window.addEventListener('scroll', handleScroll);
    window.addEventListener('mousemove', moveCursor);
    
    // 模擬進站人數 (解決不顯示問題)
    const timer = setTimeout(() => {
      let start = 12450;
      const end = 12580;
      const duration = 2000;
      const range = end - start;
      let current = start;
      const increment = end > start ? 1 : -1;
      const stepTime = Math.abs(Math.floor(duration / range));
      const obj = setInterval(() => {
        current += increment;
        setVisitorCount(current);
        if (current === end) clearInterval(obj);
      }, stepTime);
    }, 3000);

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('mousemove', moveCursor);
      clearTimeout(timer);
    };
  }, []);

  // 粒子特效初始化
  useEffect(() => {
    if (isLoading) return;
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    const resize = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };
    
    class Particle {
      constructor(x, y) {
        this.x = x; this.y = y;
        this.size = Math.random() * 2 + 0.5;
        this.speedX = Math.random() * 2 - 1;
        this.speedY = Math.random() * 2 - 1;
        this.life = 1; this.decay = Math.random() * 0.02 + 0.01;
        this.color = '#6366f1';
      }
      update() { this.x += this.speedX; this.y += this.speedY; this.life -= this.decay; }
      draw() {
        ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
      }
    }

    const handleMove = (e) => {
      for(let i=0; i<3; i++) particles.push(new Particle(e.clientX, e.clientY));
    };

    window.addEventListener('resize', resize);
    window.addEventListener('mousemove', handleMove);
    resize();

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < particles.length; i++) {
        particles[i].update(); particles[i].draw();
        if (particles[i].life <= 0) { particles.splice(i, 1); i--; }
      }
      requestAnimationFrame(animate);
    };
    animate();

    return () => {
      window.removeEventListener('resize', resize);
      window.removeEventListener('mousemove', handleMove);
    };
  }, [isLoading]);

  const handleCVUnlock = () => {
    if (cvPassword === "2026") { setIsCvUnlocked(true); setPasswordError(false); }
    else { setPasswordError(true); setCvPassword(""); }
  };

  if (isLoading) {
    return (
      <div className="fixed inset-0 z-[10005] bg-[#030303] flex flex-col items-center justify-center font-mono text-center overflow-hidden">
        <div className="absolute w-full h-2 bg-indigo-600/10 top-0 overflow-hidden">
            <div className="h-full bg-indigo-600 animate-[scanline_2s_linear_infinite]" style={{width: '20%'}}></div>
        </div>
        <div className="relative px-6 text-indigo-600">
          <div className="flex items-center justify-center space-x-6 mb-12">
            <Cpu size={48} className="animate-pulse" />
            <div className="h-[1px] w-20 bg-zinc-800"></div>
            <div className="text-4xl font-black tracking-tighter text-white uppercase italic">Diamond</div>
          </div>
          <div className="text-[12px] tracking-[0.8em] text-indigo-500 mb-6 font-bold uppercase animate-pulse">SYSTEM INITIALIZING</div>
          <button 
            onClick={() => setIsLoading(false)}
            className="mt-8 px-8 py-3 border border-indigo-500/30 text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all rounded-full uppercase text-xs tracking-widest font-black"
          >
            Enter Experience
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={`relative font-sans antialiased selection:bg-indigo-500 selection:text-white ${isDark ? 'bg-[#030303] text-zinc-100' : 'bg-[#fcfcfc] text-zinc-900'}`}>
      <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-[9998]" />
      
      {/* Background Noise Effect */}
      <div className="fixed top-0 left-0 w-full h-full opacity-[0.03] pointer-events-none z-[9999] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>

      {/* Progress Bar */}
      <div className="fixed top-0 left-0 h-1 bg-indigo-600 z-[10001] transition-all" style={{ width: `${scrollProgress * 100}%` }}></div>

      {/* Custom Cursor Circle */}
      <div className="fixed w-8 h-8 border border-indigo-500 rounded-full pointer-events-none z-[10000] transition-transform duration-150 hidden md:block" style={{ left: cursorPos.x - 16, top: cursorPos.y - 16, mixBlendMode: 'difference' }}></div>

      {/* Navigation */}
      <nav className={`fixed top-0 w-full z-[1000] px-6 md:px-12 py-6 flex justify-between items-center backdrop-blur-3xl border-b transition-all ${isDark ? 'bg-[#030303]/80 border-zinc-800/50' : 'bg-[#fafafa]/80 border-zinc-200/50'}`}>
        <div className="text-xl md:text-2xl font-black tracking-tighter uppercase cursor-pointer">
          Diamond <span className="text-indigo-600">Feng</span>
        </div>
        
        <div className="hidden lg:flex space-x-12 text-[11px] font-black tracking-[0.3em] uppercase items-center opacity-60">
          <a href="#about" className="hover:text-indigo-600 transition-all">Summary</a>
          <a href="#core-career" className="hover:text-indigo-600 transition-all">Career</a>
          <a href="#brand" className="hover:text-indigo-600 transition-all">Brand</a>
          <button onClick={() => setIsCVModalOpen(true)} className="flex items-center space-x-2 text-indigo-500">
            <FileText size={16} /><span>Full CV</span>
          </button>
          <a href="#contact" className="px-8 py-2.5 bg-indigo-600 text-white rounded-full font-bold hover:bg-indigo-700 transition-all shadow-xl">Contact</a>
        </div>

        <div className="flex items-center space-x-4">
          <button onClick={() => setIsDark(!isDark)} className="p-2.5 bg-zinc-500/10 rounded-full text-indigo-600 transition-all">
            {isDark ? <Sun size={20} /> : <Moon size={20} />}
          </button>
          <button onClick={() => setIsMenuOpen(true)} className="lg:hidden text-indigo-600"><Menu size={26} /></button>
        </div>
      </nav>

      {/* Hero Section */}
      <section className="min-h-screen flex flex-col justify-center px-6 md:px-24 relative pt-32 pb-24 overflow-hidden">
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-indigo-600/5 blur-[120px] rounded-full"></div>
        <div className="relative z-10 grid grid-cols-1 lg:grid-cols-12 gap-16 items-center">
          <div className="lg:col-span-8 text-center lg:text-left">
            <div className="flex items-center justify-center lg:justify-start space-x-3 mb-8 text-indigo-600">
              <Sparkles size={20} />
              <span className="text-[10px] font-black tracking-[0.6em] uppercase">AI CONTENT ARCHITECT</span>
            </div>
            <h1 className="text-[12vw] md:text-[8vw] font-black leading-[0.85] tracking-tighter mb-12 uppercase">
              馮興怡 <br />
              <span className="italic font-serif text-transparent bg-clip-text bg-gradient-to-r from-zinc-500 to-indigo-600">Diamond Feng</span>
            </h1>
            <p className="text-2xl md:text-4xl text-zinc-500 font-light mb-16 uppercase leading-tight">
              內容營運與增長專家 <br/>
              <span className="text-indigo-600 font-bold italic font-serif">AI-Driven Growth</span>
            </p>
            <div className="flex flex-wrap justify-center lg:justify-start gap-6">
              <a href="#contact" className="px-12 py-5 bg-indigo-600 text-white text-xs font-black tracking-[0.2em] uppercase rounded-sm hover:-translate-y-1 transition-all">Connect</a>
              <a href="#brand" className="px-12 py-5 border border-zinc-500/30 text-xs font-black tracking-[0.2em] uppercase rounded-sm hover:bg-zinc-500/10 transition-all">Projects</a>
            </div>
          </div>
          <div className="lg:col-span-4 flex justify-center">
            <div className="relative w-64 h-80 md:w-80 md:h-[480px] bg-zinc-800 border-[12px] border-white dark:border-zinc-900 shadow-2xl rotate-3 hover:rotate-0 transition-transform duration-700 overflow-hidden">
                <div className="absolute inset-0 flex items-center justify-center text-4xl font-serif italic text-zinc-700">Diamond</div>
                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=1974&auto=format&fit=crop" className="w-full h-full object-cover opacity-80" alt="Profile" />
            </div>
          </div>
        </div>
      </section>

      {/* Summary Section - 文字放大重點 */}
      <section id="about" className={`py-48 px-6 md:px-24 border-y ${isDark ? 'bg-[#060606] border-zinc-800' : 'bg-zinc-50 border-zinc-200'}`}>
        <div className="max-w-6xl mx-auto text-center">
          <h2 className="text-[10px] font-black tracking-[1em] text-indigo-600 mb-20 uppercase">EXECUTIVE SUMMARY</h2>
          
          <h3 className="text-4xl md:text-6xl lg:text-7xl font-serif italic leading-tight mb-24 tracking-tight">
            橫跨實體零售 電商與媒體領域逾 10 年經驗 <br/>
            <span className="text-indigo-600">AI 工作流將分散資訊轉化為高增長方案</span>
          </h3>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-16 md:gap-24 text-left">
            {/* 放大後的文字區塊 */}
            <p className="text-2xl md:text-3xl lg:text-4xl leading-relaxed text-zinc-500 dark:text-zinc-400 font-light border-l-4 border-indigo-600/30 pl-8">
              具備橫跨實體零售、旅遊、電商與媒體領域超過 <span className="text-indigo-600 font-bold">10 年</span>的豐富經驗，曾於大型企業、外商與新創公司發揮影響力，親自參與從採訪、寫作到網站及內容產品規劃等全流程，將多方期待整合為具體可執行的內容方案。
            </p>
            <p className="text-2xl md:text-3xl lg:text-4xl leading-relaxed text-zinc-500 dark:text-zinc-400 font-light border-l-4 border-emerald-600/30 pl-8">
              善於發掘潛在問題並提出切實可行的解決策略，曾協助優化網站架構與內容，於一年內達成單月突破 <span className="text-emerald-500 font-bold">1.38M PV</span> 並建立高效獲利模型，精通利用 <span className="bg-indigo-500/10 px-2 text-indigo-500 font-mono">GAS + LLM</span> 提升營運效率。
            </p>
          </div>
        </div>
      </section>

      {/* Metrics Section */}
      <section className="py-24 px-6 md:px-24 bg-zinc-900 text-white overflow-hidden">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div className="md:col-span-2 p-12 bg-white/5 border border-white/10 rounded-2xl relative group">
            <TrendingUp size={200} className="absolute -right-10 -bottom-10 opacity-5 group-hover:opacity-10 transition-opacity" />
            <span className="text-xs font-black tracking-widest text-indigo-400 uppercase">Growth Impact</span>
            <div className="text-8xl md:text-[10rem] font-black tracking-tighter mt-4">1.38M</div>
            <p className="text-xl opacity-50 uppercase tracking-tighter">Monthly Page Views</p>
          </div>
          <div className="p-12 bg-indigo-600 rounded-2xl flex flex-col justify-center">
            <div className="text-5xl font-black italic">33K+</div>
            <p className="text-sm uppercase tracking-widest opacity-80 mt-4">Followers in 10 Days</p>
          </div>
          <div className="p-12 bg-zinc-800 rounded-2xl border border-white/5 flex flex-col justify-center">
            <div className="text-5xl font-black text-emerald-500">300%</div>
            <p className="text-sm uppercase tracking-widest opacity-50 mt-4">Value Premium Scaling</p>
          </div>
        </div>
      </section>

      {/* CV Modal */}
      {isCVModalOpen && (
        <div className="fixed inset-0 z-[10006] flex items-center justify-center p-6 backdrop-blur-md">
          <div className="absolute inset-0 bg-black/80" onClick={() => setIsCVModalOpen(false)}></div>
          <div className={`relative w-full max-w-md p-10 rounded-2xl border shadow-2xl transition-all ${isDark ? 'bg-[#0a0a0a] border-zinc-800' : 'bg-white border-zinc-200'}`}>
            <button onClick={() => setIsCVModalOpen(false)} className="absolute top-6 right-6 opacity-50 hover:opacity-100"><X size={24} /></button>
            {!isCvUnlocked ? (
              <div className="text-center">
                <div className="w-16 h-16 bg-indigo-500/10 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6"><Lock size={32} /></div>
                <h3 className="text-2xl font-black mb-4 uppercase">Resume Vault</h3>
                <p className="text-sm opacity-60 mb-8">請輸入專屬訪問碼以獲取完整版 PDF</p>
                <input 
                  type="password" 
                  value={cvPassword}
                  onChange={(e) => setCvPassword(e.target.value)}
                  placeholder="Password"
                  className={`w-full bg-zinc-500/10 border ${passwordError ? 'border-red-500' : 'border-zinc-500/20'} rounded-lg px-4 py-4 text-center tracking-[0.5em] focus:outline-none mb-4`} 
                />
                {passwordError && <p className="text-red-500 text-xs mb-4">訪問碼錯誤</p>}
                <button onClick={handleCVUnlock} className="w-full bg-indigo-600 py-4 rounded-lg font-bold">Unlock</button>
              </div>
            ) : (
              <div className="text-center">
                <div className="w-16 h-16 bg-emerald-500/10 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6"><Download size={32} /></div>
                <h3 className="text-2xl font-black mb-4">Access Granted</h3>
                <p className="text-sm opacity-60 mb-8">您可以下載最新版履歷了</p>
                <button className="w-full bg-emerald-600 py-4 rounded-lg font-bold flex items-center justify-center gap-2">
                  <Download size={18} /> Download PDF
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Footer & Visitor Count */}
      <footer id="contact" className="py-32 px-6 md:px-24 text-center relative overflow-hidden">
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[20vw] font-black text-indigo-600/5 italic pointer-events-none uppercase">DIAMOND</div>
        <div className="relative z-10">
          <h2 className="text-6xl md:text-8xl font-black tracking-tighter mb-12 italic uppercase">Let's scale <br/><span className="text-indigo-600">your story</span></h2>
          <a href="mailto:fengdiamond@gmail.com" className="text-2xl md:text-5xl font-black tracking-tighter hover:text-indigo-600 transition-all underline underline-offset-8 decoration-indigo-600/20">fengdiamond@gmail.com</a>
          
          <div className="mt-32 pt-12 border-t border-zinc-500/10 flex flex-col md:flex-row justify-between items-center gap-8 text-[10px] font-black tracking-[0.4em] opacity-40">
            <span>© 2026 DIAMOND FENG. ALL RIGHTS RESERVED.</span>
            <div className="flex items-center gap-4 bg-indigo-500/5 px-6 py-3 rounded-full border border-indigo-500/10">
              <span className="text-indigo-500">TOTAL VISITS: {visitorCount.toLocaleString()}</span>
            </div>
            <span>TAIPEI, TAIWAN</span>
          </div>
        </div>
      </footer>

      {/* Mobile Menu */}
      {isMenuOpen && (
        <div className="fixed inset-0 z-[10002] bg-[#030303] p-10 flex flex-col justify-center text-white italic font-black">
          <button onClick={() => setIsMenuOpen(false)} className="absolute top-10 right-10"><X size={40} /></button>
          <div className="space-y-12 text-6xl tracking-tighter border-l-8 border-indigo-600 pl-8">
            <a href="#about" onClick={() => setIsMenuOpen(false)} className="block uppercase">Summary</a>
            <a href="#core-career" onClick={() => setIsMenuOpen(false)} className="block uppercase">Career</a>
            <a href="#brand" onClick={() => setIsMenuOpen(false)} className="block uppercase">Brand</a>
            <a href="#contact" onClick={() => setIsMenuOpen(false)} className="block text-indigo-600 uppercase">Connect</a>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
